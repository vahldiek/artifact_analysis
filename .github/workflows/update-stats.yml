name: Update Research Artifacts Statistics

on:
  # Run monthly on the 1st at 00:00 UTC
  schedule:
    - cron: '0 0 1 * *'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  update-statistics:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout artifact_analysis repository
        uses: actions/checkout@v4
        with:
          path: artifact_analysis
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Checkout researchartifacts.github.io repository
        uses: actions/checkout@v4
        with:
          repository: researchartifacts/researchartifacts.github.io
          path: website
          token: ${{ secrets.WEBSITE_UPDATE_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          cd artifact_analysis
          pip install -r requirements.txt
      
      - name: Create output directories
        run: |
          mkdir -p website/_data
          mkdir -p website/assets/data
          mkdir -p website/assets/charts
      
      - name: Generate statistics
        run: |
          cd artifact_analysis
          python generate_statistics.py \
            --conf_regex '.*20[12][0-9]' \
            --output_dir ../website

      - name: Generate repository statistics
        run: |
          cd artifact_analysis
          python generate_repo_stats.py \
            --conf_regex '.*20[12][0-9]' \
            --output_dir ../website || echo "âš ï¸ Repository stats failed (may need API access)"
      
      - name: Generate visualizations
        run: |
          cd artifact_analysis
          python generate_visualizations.py --data_dir ../website
      
      - name: Verify generated files
        run: |
          echo "Checking generated files..."
          ls -lh website/_data/
          ls -lh website/assets/data/
          ls -lh website/assets/charts/
          echo "Files generated successfully!"
      
      - name: Generate per-area author data
        run: |
          cd artifact_analysis
          python generate_area_authors.py --data_dir ../website
      
      - name: Download DBLP author analysis artifact (if available)
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: dblp-author-analysis.yml
          workflow_conclusion: success
          name: dblp-analysis-results
          path: dblp-results/
          skip_unpack: false
        continue-on-error: true
      
      - name: Merge DBLP results if available
        run: |
          if [ -d "dblp-results" ] && [ "$(ls -A dblp-results)" ]; then
            echo "Found DBLP analysis results, merging into website..."
            cp -r dblp-results/_data/* website/_data/ 2>/dev/null || true
            cp -r dblp-results/assets/data/* website/assets/data/ 2>/dev/null || true
            echo "DBLP results merged successfully"
          else
            echo "âš ï¸ No recent DBLP analysis results found"
            echo "Note: DBLP author analysis runs separately - see dblp-author-analysis workflow"
          fi
      
      - name: Commit and push changes
        run: |
          cd website
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Add all generated files
          git add _data/ assets/
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update statistics (automated)"
            git push
            echo "Changes pushed successfully"
          fi
      
      - name: Summary
        run: |
          echo "## Statistics Update Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Statistics generated" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Repository statistics collected" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Visualizations created" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Per-area author data generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Author DBLP analysis runs separately (workflow: dblp-author-analysis)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ Website will rebuild automatically via GitHub Pages" >> $GITHUB_STEP_SUMMARY
